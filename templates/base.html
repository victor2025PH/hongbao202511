<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ title or "Admin" }}</title>
  <!-- Tailwindï¼šCDN å¤Ÿç”¨ï¼›å†…ç½‘å°±è‡ªå·±æ‰“åŒ…é™æ€ CSS æ›¿æ¢ -->
  <script src="https://cdn.tailwindcss.com"></script>

  {# === å…¨å±€ CSRF æ³¨å…¥ï¼ˆä¾›æ‰€æœ‰é¡µé¢ fetch/AJAX å¤ç”¨ï¼‰ === #}
  <meta name="csrf-token" content="{{ (request and request.state and request.state.csrf_token) or (request.session.get('_csrf_token') if request and request.session else '') }}">
  <script>
    // å°† CSRF æŒ‚åˆ°å…¨å±€ï¼›å„é¡µé¢å¯ç›´æ¥ç”¨ window.__CSRF__ ä½œä¸ºè¯·æ±‚å¤´ x-csrf-token
    (function () {
      var m = document.querySelector('meta[name="csrf-token"]');
      window.__CSRF__ = (m && m.content) || '';
      // å¯é€‰ï¼šå°è£…ä¸€ä¸ªå¸¦ CSRF çš„ fetchï¼ˆæŒ‰éœ€ä½¿ç”¨ï¼‰
      window.csrfFetch = function(url, opts){
        opts = opts || {};
        opts.headers = Object.assign(
          {'x-csrf-token': window.__CSRF__},
          opts.headers || {}
        );
        return fetch(url, opts);
      };
    })();
  </script>

  <style>
    .container { max-width: 1200px; }
    .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
    details > summary { list-style: none; }
    details > summary::-webkit-details-marker { display: none; }
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  {# === RBAC é¢„ç•™ï¼šå¯åœ¨è¿™é‡Œå®šä¹‰ä¸€ä¸ªç®€å•çš„â€œå¯è§æ€§åˆ¤æ–­â€å®ï¼Œåç»­å¯æ›¿æ¢ä¸ºçœŸæ­£çš„æƒé™æ£€æŸ¥ === #}
  {% macro can_view(link_name) -%}
    {# å ä½ç­–ç•¥ï¼šå¦‚æœä»¥å session é‡Œæœ‰ perms/roleï¼Œå°±æŒ‰éœ€åˆ¤æ–­ï¼›å½“å‰é»˜è®¤æ”¾è¡Œ #}
    {%- set role = request.session.get('role') if request and request.session else None -%}
    {%- set perms = request.session.get('perms') if request and request.session else None -%}
    {# ä¾‹å¦‚ï¼šåªå…è®¸ Auditor æŸ¥çœ‹å®¡è®¡ï¼›è¿™é‡Œå…ˆä¸æ‹¦ï¼Œç­‰ RBAC æ¥å…¥æ—¶å†ç»†åŒ– #}
    {{- true -}}
  {%- endmacro %}

  <!-- é¡¶éƒ¨å¯¼èˆª -->
  <header class="bg-white border-b">
    <nav class="container mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-6">
        <a href="/admin" class="font-semibold">ğŸ›ï¸ Admin</a>

        {% if can_view('dashboard') %}
        <a href="/admin" aria-current="{{ 'page' if nav_active=='dashboard' else 'false' }}" class="text-sm {{ 'text-black font-semibold' if nav_active=='dashboard' else 'text-gray-600 hover:text-black' }}">
          {{ t('admin.nav.dashboard') }}
        </a>
        {% endif %}

        {% if can_view('covers') %}
        <a href="/admin/covers" aria-current="{{ 'page' if nav_active=='covers' else 'false' }}" class="text-sm {{ 'text-black font-semibold' if nav_active=='covers' else 'text-gray-600 hover:text-black' }}">
          Covers
        </a>
        {% endif %}

        {% if can_view('export') %}
        <a href="/admin/export" aria-current="{{ 'page' if nav_active=='export' else 'false' }}" class="text-sm {{ 'text-black font-semibold' if nav_active=='export' else 'text-gray-600 hover:text-black' }}">
          {{ t('admin.export.title') }}
        </a>
        {% endif %}

        {% if can_view('adjust') %}
        <a href="/admin/adjust" aria-current="{{ 'page' if nav_active=='adjust' else 'false' }}" class="text-sm {{ 'text-black font-semibold' if nav_active=='adjust' else 'text-gray-600 hover:text-black' }}">
          {{ t('admin.nav.adjust') }}
        </a>
        {% endif %}

        {% if can_view('reset') %}
        <a href="/admin/reset" aria-current="{{ 'page' if nav_active=='reset' else 'false' }}" class="text-sm {{ 'text-black font-semibold' if nav_active=='reset' else 'text-gray-600 hover:text-black' }}">
          {{ t('admin.nav.reset') }}
        </a>
        {% endif %}

        {% if can_view('recharge') %}
        <a href="/admin/recharge" aria-current="{{ 'page' if nav_active=='recharge' else 'false' }}" class="text-sm {{ 'text-black font-semibold' if nav_active=='recharge' else 'text-gray-600 hover:text-black' }}">
          {{ t('admin.nav.recharge') }}
        </a>
        {% endif %}

        {% if can_view('audit') %}
        <a href="/admin/audit" aria-current="{{ 'page' if nav_active=='audit' else 'false' }}" class="text-sm {{ 'text-black font-semibold' if nav_active=='audit' else 'text-gray-600 hover:text-black' }}">
          {{ t('admin.nav.audit') }}
        </a>
        {% endif %}

        {% if can_view('approvals') %}
        <a href="/admin/approvals" aria-current="{{ 'page' if nav_active=='approvals' else 'false' }}" class="text-sm {{ 'text-black font-semibold' if nav_active=='approvals' else 'text-gray-600 hover:text-black' }}">
          {{ t('admin.nav.approvals') }}
        </a>
        {% endif %}

        {% if can_view('queue') %}
        <a href="/admin/queue" aria-current="{{ 'page' if nav_active=='queue' else 'false' }}" class="text-sm {{ 'text-black font-semibold' if nav_active=='queue' else 'text-gray-600 hover:text-black' }}">
          {{ t('admin.nav.queue') }}
        </a>
        {% endif %}

        {% if can_view('tags') %}
        <a href="/admin/tags" aria-current="{{ 'page' if nav_active=='tags' else 'false' }}" class="text-sm {{ 'text-black font-semibold' if nav_active=='tags' else 'text-gray-600 hover:text-black' }}">
          {{ t('admin.nav.tags') }}
        </a>
        {% endif %}

        {% if can_view('invites') %}
        <a href="/admin/invites" aria-current="{{ 'page' if nav_active=='invites' else 'false' }}" class="text-sm {{ 'text-black font-semibold' if nav_active=='invites' else 'text-gray-600 hover:text-black' }}">
          {{ t('admin.nav.invites') }}
        </a>
        {% endif %}

        {% if can_view('users') %}
        <a href="/admin/users" aria-current="{{ 'page' if nav_active=='users' else 'false' }}" class="text-sm {{ 'text-black font-semibold' if nav_active=='users' else 'text-gray-600 hover:text-black' }}">
          {{ t('admin.nav.users') }}
        </a>
        {% endif %}

        {% if can_view('public_groups') %}
        <a href="/admin/public-groups"
           aria-current="{{ 'page' if nav_active=='public_groups' else 'false' }}"
           class="text-sm {{ 'text-black font-semibold' if nav_active=='public_groups' else 'text-gray-600 hover:text-black' }}">
          {{ t('admin.nav.public_groups') }}
        </a>
        {% endif %}

        {% if can_view('public_group_reports') %}
        <a href="/admin/public-groups/reports"
           aria-current="{{ 'page' if nav_active=='public_group_reports' else 'false' }}"
           class="text-sm {{ 'text-black font-semibold' if nav_active=='public_group_reports' else 'text-gray-600 hover:text-black' }}">
          {{ t('admin.nav.public_group_reports') }}
        </a>
        {% endif %}

        {% if can_view('sheet_users') %}
        <!-- â€œç”¨æˆ·èµ„æ–™â€å…¥å£ï¼ˆGoogle Sheet åå°ï¼‰ -->
        <a href="/admin/sheet-users"
           aria-current="{{ 'page' if nav_active=='sheet_users' else 'false' }}"
           class="text-sm {{ 'text-black font-semibold' if nav_active=='sheet_users' else 'text-gray-600 hover:text-black' }}">
          ç”¨æˆ·èµ„æ–™
        </a>
        {% endif %}
      </div>

      <div class="flex items-center gap-3">
        {% if can_view('settings') %}
        <a href="/admin/settings" aria-current="{{ 'page' if nav_active=='settings' else 'false' }}" class="text-sm {{ 'text-black font-semibold' if nav_active=='settings' else 'text-gray-600 hover:text-black' }}">
          {{ t('admin.settings.title') }}
        </a>
        {% endif %}
        {% if can_view('a11y') %}
        <a href="/admin/a11y" aria-current="{{ 'page' if nav_active=='a11y' else 'false' }}" class="text-sm {{ 'text-black font-semibold' if nav_active=='a11y' else 'text-gray-600 hover:text-black' }}">
          A11y
        </a>
        {% endif %}

        {# ç™»å‡ºè¡¨å•ï¼šæ”¯æŒ CSRFï¼ˆæ¸è¿›å¼ï¼‰ã€‚#}
        {% set __csrf = (csrf_token if csrf_token is defined else (request.session.get('_csrf_token') if request and request.session else '')) %}
        <form method="post" action="/admin/logout">
          <input type="hidden" name="csrf_token" value="{{ __csrf }}">
          <button class="text-sm text-gray-600 hover:text-black">{{ t('admin.nav.signout') }}</button>
        </form>
      </div>
    </nav>
  </header>

  <!-- ä¸»ä½“ -->
  <main class="container mx-auto px-4 py-6">
    {# å…¼å®¹ï¼šå°‘æ•°é¡µé¢è¿˜åœ¨ç”¨ query å‚æ•°ä¼ æç¤º #}
    {% if request.query_params.get('error') %}
      <div class="mb-4 p-3 border border-red-200 bg-red-50 text-red-700 rounded">{{ request.query_params.get('error') }}</div>
    {% endif %}
    {% if request.query_params.get('ok') or request.query_params.get('message') %}
      <div class="mb-4 p-3 border border-green-200 bg-green-50 text-green-700 rounded">
        {{ request.query_params.get('ok') or request.query_params.get('message') }}
      </div>
    {% endif %}

    {% block content %}{% endblock %}
  </main>

  <footer class="container mx-auto px-4 py-8 text-center text-xs text-gray-400">
    <span>Â© {{ (now() if now else None) or '' }} Admin Console</span>
  </footer>
</body>
</html>
