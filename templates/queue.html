{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">{{ t("admin.queue.title") }}</h1>

<div class="grid md:grid-cols-2 gap-6 mb-6">
  <!-- 快速入队 -->
  <form method="post" action="/admin/queue/enqueue" class="bg-white shadow rounded-xl p-4 space-y-3">
    <div class="font-semibold">{{ t("admin.export.title") }} · Quick</div>
    <div class="flex flex-col gap-2">
      <button name="kind" value="ALL_USERS_LEDGER" class="px-4 py-2 rounded-md bg-black text-white">
        {{ t("admin.export.all_users_ledger") }}
      </button>
      <button name="kind" value="USERS_ONLY" class="px-4 py-2 rounded-md border">
        {{ t("admin.export.users_only") }}
      </button>
      <button name="kind" value="LEDGER_ONLY" class="px-4 py-2 rounded-md border">
        {{ t("admin.export.ledger_only") }}
      </button>
    </div>
  </form>

  <!-- 指定用户合并导出 -->
  <form method="post" action="/admin/queue/enqueue" class="bg-white shadow rounded-xl p-4 space-y-3">
    <div class="font-semibold">{{ t("admin.export.selected_users") }} (merged)</div>
    <p class="text-sm text-gray-500">{{ t("admin.export.users_label") }}</p>
    <textarea name="users" rows="5" class="w-full border rounded-md p-2" placeholder="12345678, @alice, @bob"></textarea>
    <button name="kind" value="SELECTED_MERGED" class="px-4 py-2 rounded-md bg-black text-white">
      {{ t("admin.common.download") }}
    </button>
  </form>
</div>

<div class="bg-white shadow rounded-xl overflow-x-auto">
  <table class="min-w-full text-sm">
    <thead>
      <tr class="text-left text-gray-500">
        <th class="py-2 px-3">ID</th>
        <th class="py-2 px-3">Kind</th>
        <th class="py-2 px-3">{{ t("admin.common.status") }}</th>
        <th class="py-2 px-3">{{ t("admin.common.created_at") }}</th>
        <th class="py-2 px-3">{{ t("admin.common.updated_at") }}</th>
        <th class="py-2 px-3">{{ t("admin.common.actions") }}</th>
      </tr>
    </thead>
    <tbody id="job-table">
      {% for j in rows %}
      <tr class="border-t" data-id="{{ j.id }}">
        <td class="py-2 px-3">{{ j.id }}</td>
        <td class="py-2 px-3 font-mono">{{ j.kind }}</td>
        <td class="py-2 px-3 status">{{ j.status }}</td>
        <td class="py-2 px-3">{{ j.created_at }}</td>
        <td class="py-2 px-3">{{ j.updated_at }}</td>
        <td class="py-2 px-3">
          {% if j.status == 'DONE' and j.result_path %}
          <a href="/admin/queue/download/{{ j.id }}" class="text-xs underline">{{ t("admin.common.download") }}</a>
          {% else %}
          —
          {% endif %}
        </td>
      </tr>
      {% endfor %}
      {% if rows|length == 0 %}
      <tr><td colspan="6" class="py-6 text-center text-gray-400">No jobs</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- 简易轮询：每 3 秒刷新一次未完成任务 -->
<script>
(function(){
  function refreshRow(tr){
    const id = tr.getAttribute('data-id');
    fetch('/admin/queue/status?id=' + id)
      .then(r => r.json())
      .then(j => {
        tr.querySelector('.status').textContent = j.status;
        if (j.status === 'DONE' && j.result_path){
          tr.querySelector('td:last-child').innerHTML =
            '<a class="text-xs underline" href="/admin/queue/download/' + id + '">{{ t("admin.common.download") }}</a>';
        }
      })
      .catch(()=>{});
  }
  function tick(){
    document.querySelectorAll('#job-table tr').forEach(tr => {
      const st = tr.querySelector('.status').textContent.trim();
      if (st === 'PENDING' || st === 'RUNNING'){
        refreshRow(tr);
      }
    });
  }
  setInterval(tick, 3000);
})();
</script>

<div class="flex justify-between mt-4">
  {% if page > 1 %}
    <a href="?page={{ page - 1 }}" class="text-sm text-gray-700">{{ t("admin.pagination.prev") }}</a>
  {% endif %}
  {% if page < total_pages %}
    <a href="?page={{ page + 1 }}" class="text-sm text-gray-700">{{ t("admin.pagination.next") }}</a>
  {% endif %}
</div>
{% endblock %}
