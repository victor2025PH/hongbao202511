{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl font-semibold mb-4">Users</h1>

{# ---------- 安全格式化宏 ---------- #}
{% macro fmt_dt(v) -%}
  {%- if v is not none -%}
    {%- if v is string -%}
      {{ v }}
    {%- else -%}
      {{ v.strftime("%Y-%m-%d %H:%M:%S") }}
    {%- endif -%}
  {%- else -%}
    —
  {%- endif -%}
{%- endmacro %}

{% macro fmt_num(v, max_places=8) -%}
  {%- if v is none -%}—{%- else -%}
    {%- if v is string -%}
      {{ v }}
    {%- else -%}
      {%- set s = ("{:." ~ max_places ~ "f}").format(v)|trim -%}
      {{ s.rstrip('0').rstrip('.') if '.' in s else s }}
    {%- endif -%}
  {%- endif -%}
{%- endmacro %}

{# ---------- 通用取值宏：兼容 ORM / Row / dict ---------- #}
{% macro F(obj, name) -%}
  {%- set _attr = (obj|attribute(name)) if (obj is defined and obj is not none) else none -%}
  {%- if _attr is defined and _attr is not undefined and _attr is not none -%}
    {{- _attr -}}
  {%- else -%}
    {%- set _m = (obj|attribute("_mapping")) if (obj is defined and obj is not none) else none -%}
    {%- if _m and (name in _m) -%}
      {{- _m[name] -}}
    {%- else -%}
      {%- if obj is mapping and (name in obj) -%}
        {{- obj[name] -}}
      {%- else -%}
        {{- none -}}
      {%- endif -%}
    {%- endif -%}
  {%- endif -%}
{%- endmacro %}

{# ---------- 工具栏：筛选 + 导出 ---------- #}
<form method="get" action="/admin/users" class="bg-white shadow rounded-xl p-4 grid md:grid-cols-6 gap-3 mb-4 text-sm">
  <div class="md:col-span-2">
    <label class="block text-gray-600 mb-1">{{ t("admin.common.search") }}</label>
    <input name="q" value="{{ filters.q|default('') }}" class="w-full border rounded-md p-2" placeholder="123456 or @name"/>
  </div>
  <div>
    <label class="block text-gray-600 mb-1">{{ t("admin.filters.token") }}</label>
    <select name="token" class="w-full border rounded-md p-2">
      <option value="">{{ t("admin.table.token") }}</option>
      {% for tk in tokens %}
      <option value="{{ tk }}" {% if (filters.token|default(''))==tk %}selected{% endif %}>{{ tk }}</option>
      {% endfor %}
    </select>
  </div>
  <div>
    <label class="block text-gray-600 mb-1">{{ t("admin.filters.balance_range") }}</label>
    <div class="flex gap-2">
      <input name="min_b" value="{{ filters.min_b|default('') }}" class="w-full border rounded-md p-2" placeholder="min"/>
      <input name="max_b" value="{{ filters.max_b|default('') }}" class="w-full border rounded-md p-2" placeholder="max"/>
    </div>
  </div>
  <div>
    <label class="block text-gray-600 mb-1">{{ t("admin.filters.active_since") }}</label>
    <input name="active_since" value="{{ filters.active_since|default('') }}" class="w-full border rounded-md p-2" placeholder="2025-01-01"/>
  </div>
  <div class="md:col-span-2">
    <label class="block text-gray-600 mb-1">{{ t("admin.filters.created_between") }}</label>
    <div class="flex gap-2">
      <input name="created_start" value="{{ filters.created_start|default('') }}" class="w-full border rounded-md p-2" placeholder="start"/>
      <input name="created_end" value="{{ filters.created_end|default('') }}" class="w-full border rounded-md p-2" placeholder="end"/>
    </div>
  </div>
  <div>
    <label class="block text-gray-600 mb-1">{{ t("admin.filters.invited_by") }}</label>
    <input name="invited_by" value="{{ filters.invited_by|default('') }}" class="w-full border rounded-md p-2" placeholder="123456 or @referrer"/>
  </div>

  <div class="md:col-span-6 flex items-center gap-2">
    <button class="px-4 py-2 bg-black text-white rounded-md">{{ t("admin.common.search") }}</button>

    {# 导出：继承当前筛选参数 #}
    {% set _qs = request.url.query %}
    <a class="px-3 py-2 border rounded-md text-gray-700 hover:bg-gray-50"
       href="/admin/users/export.csv{% if _qs %}?{{ _qs }}{% endif %}">
      CSV
    </a>
    <a class="px-3 py-2 border rounded-md text-gray-700 hover:bg-gray-50"
       href="/admin/users/export.json{% if _qs %}?{{ _qs }}{% endif %}">
      JSON
    </a>
  </div>
</form>

{# ---------- 列表 ---------- #}
<div class="bg-white shadow rounded-xl overflow-x-auto">
  <table class="min-w-full text-sm">
    <thead>
      <tr class="text-left text-gray-500">
        <th class="py-2 px-3">{{ t("admin.table.user") }}</th>
        <th class="py-2 px-3">{{ t("admin.table.username") }}</th>
        <th class="py-2 px-3">{{ t("admin.common.created_at") }}</th>
        <th class="py-2 px-3">{{ t("admin.filters.active_since") }}</th>
        <th class="py-2 px-3">{{ t("admin.common.actions") }}</th>
      </tr>
    </thead>
    <tbody>
      {% for u in rows %}
      <tr class="border-t hover:bg-gray-50">
        <td class="py-2 px-3 font-mono">{{ F(u, "tg_id") or F(u, "id") }}</td>

        {# 只有存在 username 时才加 @，否则显示 — #}
        <td class="py-2 px-3">
          {% set _un = F(u, "username") %}
          {% if _un %}@{{ _un }}{% else %}—{% endif %}
        </td>

        {# 统一用 F() 取值，然后 fmt_dt() 展示 #}
        <td class="py-2 px-3">{{ fmt_dt(F(u, "created_at") or F(u, "created")) }}</td>
        <td class="py-2 px-3">{{ fmt_dt(F(u, "last_active_at") or F(u, "active_at")) }}</td>

        <td class="py-2 px-3">
          <a href="/admin/users/{{ F(u, 'tg_id') or F(u, 'id') }}" class="text-xs underline">{{ t("admin.common.preview") }}</a>
        </td>
      </tr>
      {% endfor %}
      {% if rows|length == 0 %}
      <tr><td colspan="5" class="py-6 text-center text-gray-400">{{ t("admin.errors.not_found") }}</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

{# ---------- 分页 ---------- #}
<div class="flex justify-between mt-4">
  {% if page > 1 %}
    <a href="{{ request.url.include_query_params(page=page-1) }}" class="text-sm text-gray-700">{{ t("admin.pagination.prev") }}</a>
  {% endif %}
  {% if page < total_pages %}
    <a href="{{ request.url.include_query_params(page=page+1) }}" class="text-sm text-gray-700">{{ t("admin.pagination.next") }}</a>
  {% endif %}
</div>
{% endblock %}
