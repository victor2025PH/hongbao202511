<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>{{ title or "Admin Login" }}</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .container{max-width:960px}
  </style>
</head>
<body class="bg-gray-100 text-gray-900">
  <header class="bg-white border-b">
    <nav class="container mx-auto px-4 py-3 flex items-center justify-between">
      <a href="/admin" class="font-semibold">ğŸ›ï¸ Admin</a>
    </nav>
  </header>

  <main class="container mx-auto px-4 py-8">
    <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow p-6">
      <h1 class="text-2xl font-semibold mb-4">{{ t("admin.login.title") if t else "ç®¡ç†å‘˜ç™»å½•" }}</h1>

      {% if message %}
      <!-- æœ‰æç¤ºæ¶ˆæ¯æ—¶ï¼Œåšå¯è¾¾æ€§å¢å¼º -->
      <div role="alert" aria-live="polite" class="mb-4 p-3 rounded border
                  {% if 'invalid' in message or 'missing' in message or 'expired' in message or 'csrf' in message %}
                    border-red-200 bg-red-50 text-red-700
                  {% else %}
                    border-green-200 bg-green-50 text-green-700
                  {% endif %}">{{ message }}</div>
      {% endif %}

      <!-- ç™»å½•è¡¨å• -->
      <form method="post" action="/admin/login" class="space-y-4" id="login-form">
        <!-- CSRFï¼šåç«¯åœ¨ /admin/login GET æ—¶ä¸‹å‘ -->
        <input type="hidden" name="csrf_token" id="csrf_token" value="{{ csrf_token or '' }}">

        <div>
          <label class="block text-sm text-gray-600 mb-1" for="username">ç®¡ç†å‘˜è´¦å·</label>
          <input type="text" name="username" id="username" value="{{ username or '' }}" required autofocus
                 class="w-full border rounded-md px-3 py-2" placeholder="admin" autocomplete="username" />
        </div>

        <div>
          <label class="block text-sm text-gray-600 mb-1" for="password">å¯†ç </label>
          <input type="password" name="password" id="password" required
                 class="w-full border rounded-md px-3 py-2" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />
        </div>

        <div>
          <div class="flex items-center justify-between">
            <label class="block text-sm text-gray-600 mb-1" for="otp">6ä½éªŒè¯ç </label>
            {% if totp_enabled %}
              <span class="text-xs text-blue-600">å·²å¯ç”¨ TOTPï¼Œå¯ç›´æ¥è¾“å…¥ App ä¸Šçš„ä¸€æ¬¡æ€§éªŒè¯ç </span>
            {% endif %}
          </div>
          <input name="otp" id="otp" value=""
                 class="w-full border rounded-md px-3 py-2" placeholder="123456"
                 inputmode="numeric" pattern="\\d{6}" maxlength="6" />
          <p class="text-xs text-gray-500 mt-1">
            {% if totp_enabled %}
              ä½¿ç”¨ Google Authenticator ç­‰ TOTP åº”ç”¨çš„åŠ¨æ€ç ï¼›æ— éœ€ç‚¹å‡»å‘é€ã€‚
            {% else %}
              ç™»å½•éœ€äºŒæ¬¡éªŒè¯ï¼šç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å‘é€éªŒè¯ç åˆ° Telegramï¼Œå†åœ¨æ­¤è¾“å…¥éªŒè¯ç æäº¤ã€‚
            {% endif %}
          </p>
          {% if otp_pending %}
            <p class="text-xs text-amber-600 mt-1">éªŒè¯ç å·²è¯·æ±‚ï¼Œè‹¥æœªæ”¶åˆ°è¯· {{ (otp_ttl or 600) // 60 }} åˆ†é’Ÿåé‡è¯•ã€‚</p>
          {% endif %}
        </div>

        <div class="flex items-center gap-3">
          <button type="submit" class="px-4 py-2 rounded-xl bg-black text-white">ç™»å½•</button>

          {% if not totp_enabled %}
          <!-- ä»…åœ¨æœªå¯ç”¨ TOTP æ—¶æ˜¾ç¤ºâ€œå‘é€éªŒè¯ç â€æŒ‰é’® -->
          <button type="button" id="send-otp" class="px-4 py-2 rounded-xl border">å‘é€éªŒè¯ç åˆ° Telegram</button>
          <span id="otp-status" class="text-sm text-gray-600"></span>
          {% endif %}
        </div>
      </form>
    </div>
  </main>

  <footer class="container mx-auto px-4 py-8 text-center text-xs text-gray-400">
    Â© 2025 Admin Console
  </footer>

  <script>
    (function() {
      const btn = document.getElementById('send-otp');
      const statusEl = document.getElementById('otp-status');
      const csrfEl = document.getElementById('csrf_token');

      if (!btn) return; // å¯ç”¨äº† TOTP æ—¶æŒ‰é’®ä¸å­˜åœ¨

      btn.addEventListener('click', async () => {
        // é˜²è¿ç‚¹ & UI æç¤º
        const oldText = btn.textContent;
        btn.disabled = true;
        btn.textContent = 'å‘é€ä¸­â€¦';
        if (statusEl) statusEl.textContent = 'å‘é€ä¸­...';

        try {
          // åç«¯ /admin/send_otp éœ€è¦ CSRF
          const params = new URLSearchParams();
          params.set('csrf_token', csrfEl ? csrfEl.value : '');

          const res = await fetch('/admin/send_otp', {
            method: 'POST',
            headers: {'Content-Type': 'application/x-www-form-urlencoded'},
            body: params.toString()
          });

          const js = await res.json();

          // æˆåŠŸåˆ™æ›´æ–°æç¤ºï¼›åç«¯ä¼šå›ä¼ æ–°çš„ csrf_tokenï¼Œé˜²é‡æ”¾
          if (js && js.ok) {
            if (statusEl) statusEl.textContent = 'éªŒè¯ç å·²å‘é€ï¼Œè¯·æŸ¥æ”¶ Telegram';
            if (js.csrf_token && csrfEl) csrfEl.value = js.csrf_token;
          } else {
            if (statusEl) statusEl.textContent = 'å‘é€å¤±è´¥ï¼š' + (js.error || js.message || 'unknown');
            if (js.csrf_token && csrfEl) csrfEl.value = js.csrf_token;
          }
        } catch (e) {
          if (statusEl) statusEl.textContent = 'å‘é€å¤±è´¥ï¼šç½‘ç»œé”™è¯¯';
        } finally {
          btn.disabled = false;
          btn.textContent = oldText;
        }
      });
    })();
  </script>
</body>
</html>
