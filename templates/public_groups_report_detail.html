{% extends "base.html" %}
{% block content %}
<div class="flex justify-between items-center mb-6">
  <div>
    <h1 class="text-xl font-semibold">{{ t('admin.public_groups_reports.detail_title') }}</h1>
    <p class="text-sm text-gray-500">{{ t('admin.public_groups_reports.detail_subtitle') }}</p>
  </div>
  <a href="/admin/public-groups/reports"
     class="px-3 py-2 text-sm border rounded text-gray-700 hover:bg-gray-100">
    {{ t('admin.public_groups_reports.back_to_list') }}
  </a>
</div>

{% if request.query_params.get('ok') %}
  <div class="mb-4 p-3 border border-green-200 bg-green-50 text-green-700 rounded text-sm">
    {{ t('admin.public_groups_reports.action_success') }}
  </div>
{% endif %}

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <section class="lg:col-span-2 space-y-6">
    <div class="bg-white border rounded-md p-4 shadow-sm">
      <h2 class="text-lg font-semibold text-gray-800 mb-3">{{ t('admin.public_groups_reports.report_info') }}</h2>
      <dl class="text-sm text-gray-600 space-y-2">
        <div class="flex justify-between">
          <dt class="font-medium text-gray-500">{{ t('admin.public_groups_reports.field_id') }}</dt>
          <dd>#{{ report.id }}</dd>
        </div>
        <div class="flex justify-between">
          <dt class="font-medium text-gray-500">{{ t('admin.public_groups_reports.field_status') }}</dt>
          <dd>{{ t('admin.public_groups_reports.status_' + report.status.value) }}</dd>
        </div>
        <div class="flex justify-between">
          <dt class="font-medium text-gray-500">{{ t('admin.public_groups_reports.field_priority') }}</dt>
          <dd>{{ report.priority }}</dd>
        </div>
        <div class="flex justify-between">
          <dt class="font-medium text-gray-500">{{ t('admin.public_groups_reports.field_type') }}</dt>
          <dd>{{ report.report_type }}</dd>
        </div>
        <div class="flex justify-between">
          <dt class="font-medium text-gray-500">{{ t('admin.public_groups_reports.field_reporter') }}</dt>
          <dd>
            {% if report.reporter_tg_id %}
              {{ report.reporter_tg_id }}
            {% else %}
              —
            {% endif %}
            {% if report.reporter_username %}
              <span class="text-xs text-gray-400 ml-2">@{{ report.reporter_username }}</span>
            {% endif %}
          </dd>
        </div>
        <div>
          <dt class="font-medium text-gray-500">{{ t('admin.public_groups_reports.field_description') }}</dt>
          <dd class="mt-1 whitespace-pre-wrap text-gray-700">{{ report.description or '—' }}</dd>
        </div>
        <div>
          <dt class="font-medium text-gray-500">{{ t('admin.public_groups_reports.field_resolution_note') }}</dt>
          <dd class="mt-1 whitespace-pre-wrap text-gray-700">{{ report.resolution_note or '—' }}</dd>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs text-gray-500 pt-2 border-t mt-3">
          <div>{{ t('admin.public_groups_reports.field_created') }}: {{ report.created_at }}</div>
          <div>{{ t('admin.public_groups_reports.field_updated') }}: {{ report.updated_at }}</div>
          <div>{{ t('admin.public_groups_reports.field_resolved') }}: {{ report.resolved_at or '—' }}</div>
        </div>
      </dl>
    </div>

    <div class="bg-white border rounded-md p-4 shadow-sm" id="notes">
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-semibold text-gray-800">{{ t('admin.public_groups_reports.notes_heading') }}</h2>
        <span class="text-xs text-gray-400">{{ notes|length }} {{ t('admin.public_groups_reports.notes_count') }}</span>
      </div>
      <div class="space-y-3">
        {% for note in notes %}
        <div class="border rounded p-3 text-sm">
          <div class="flex justify-between text-xs text-gray-500 mb-1">
            <span>{{ t('admin.public_groups_reports.note_operator') }}: {{ note.operator_tg_id }}</span>
            <span>{{ note.created_at }}</span>
          </div>
          <div class="whitespace-pre-wrap text-gray-700">{{ note.content }}</div>
        </div>
        {% else %}
        <p class="text-sm text-gray-500">{{ t('admin.public_groups_reports.notes_empty') }}</p>
        {% endfor %}
      </div>
    </div>
  </section>

  <aside class="space-y-6">
    <div class="bg-white border rounded-md p-4 shadow-sm">
      <h2 class="text-lg font-semibold text-gray-800 mb-3">{{ t('admin.public_groups_reports.group_info') }}</h2>
      {% if group %}
      <dl class="text-sm text-gray-600 space-y-2">
        <div class="flex justify-between">
          <dt class="font-medium text-gray-500">{{ t('admin.public_groups_reports.field_group_id') }}</dt>
          <dd>#{{ group.id }}</dd>
        </div>
        <div>
          <dt class="font-medium text-gray-500">{{ t('admin.public_groups_reports.field_group_name') }}</dt>
          <dd class="text-gray-800">{{ group.name }}</dd>
        </div>
        <div>
          <dt class="font-medium text-gray-500">{{ t('admin.public_groups_reports.field_group_link') }}</dt>
          <dd>
            <a href="{{ group.invite_link }}" target="_blank" rel="noopener" class="text-blue-600 hover:underline">
              {{ group.invite_link }}
            </a>
          </dd>
        </div>
        <div class="flex justify-between">
          <dt class="font-medium text-gray-500">{{ t('admin.public_groups_reports.field_group_status') }}</dt>
          <dd>{{ group.status.value if group.status else group.status }}</dd>
        </div>
      </dl>
      {% else %}
      <p class="text-sm text-gray-500">{{ t('admin.public_groups_reports.group_missing') }}</p>
      {% endif %}
    </div>

    <div class="bg-white border rounded-md p-4 shadow-sm">
      <h2 class="text-lg font-semibold text-gray-800 mb-3">{{ t('admin.public_groups_reports.actions_heading') }}</h2>
      <form method="post"
            action="/admin/public-groups/reports/{{ report.id }}/status"
            class="space-y-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <div>
          <label class="block text-xs text-gray-500 mb-1">{{ t('admin.public_groups_reports.action_status') }}</label>
          <select name="status"
                  class="w-full border rounded px-3 py-2 text-sm focus:border-blue-400 focus:ring-blue-200 focus:ring">
            {% for status_item in statuses %}
            <option value="{{ status_item.value }}" {% if status_item == report.status %}selected{% endif %}>
              {{ t('admin.public_groups_reports.status_' + status_item.value) }}
            </option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">{{ t('admin.public_groups_reports.action_assign') }}</label>
          <input type="text"
                 name="assigned_operator"
                 value="{{ report.assigned_operator or '' }}"
                 placeholder="{{ t('admin.public_groups_reports.action_assign_placeholder') }}"
                 class="w-full border rounded px-3 py-2 text-sm focus:border-blue-400 focus:ring-blue-200 focus:ring">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">{{ t('admin.public_groups_reports.action_priority') }}</label>
          <input type="number"
                 name="priority"
                 min="0"
                 value="{{ report.priority }}"
                 class="w-full border rounded px-3 py-2 text-sm focus:border-blue-400 focus:ring-blue-200 focus:ring">
        </div>
        <div>
          <label class="block text-xs text-gray-500 mb-1">{{ t('admin.public_groups_reports.action_resolution_note') }}</label>
          <textarea name="resolution_note"
                    rows="3"
                    class="w-full border rounded px-3 py-2 text-sm focus:border-blue-400 focus:ring-blue-200 focus:ring"
                    placeholder="{{ t('admin.public_groups_reports.action_resolution_placeholder') }}">{{ report.resolution_note or '' }}</textarea>
        </div>
        <button class="w-full px-3 py-2 text-sm rounded bg-blue-500 text-white hover:bg-blue-600">
          {{ t('admin.public_groups_reports.action_update') }}
        </button>
      </form>
    </div>

    <div class="bg-white border rounded-md p-4 shadow-sm">
      <h2 class="text-lg font-semibold text-gray-800 mb-3">{{ t('admin.public_groups_reports.notes_new') }}</h2>
      <form method="post"
            action="/admin/public-groups/reports/{{ report.id }}/notes"
            class="space-y-3">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <textarea name="content"
                  rows="3"
                  class="w-full border rounded px-3 py-2 text-sm focus:border-blue-400 focus:ring-blue-200 focus:ring"
                  placeholder="{{ t('admin.public_groups_reports.notes_placeholder') }}" required></textarea>
        <button class="w-full px-3 py-2 text-sm rounded bg-gray-700 text-white hover:bg-gray-800">
          {{ t('admin.public_groups_reports.notes_submit') }}
        </button>
      </form>
    </div>
  </aside>
</div>
{% endblock %}


